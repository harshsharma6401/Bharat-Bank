<!DOCTYPE html>
<html lang="en">
    <%-include("./partials/head.ejs") %>
    
  <head>
    <link rel="stylesheet" href="/forms.css">
  </head>
  

  <body class ="form-bg">
    <%- include('./partials/nav.ejs') %>
    
   
     <div class="login-form-outer"  > <!--class="create-user" -->
     
        <form action="" id="login" class = "form">
        <div class="title">Login</div>
        <div class="subtitle">Let's log into your account!</div>
         <div class="login-google">
        <div class="g-signin2" data-width="wide"  data-longtitle="true" data-onsuccess="onSignIn" target="_blank" >
        </div>
      </div>
          <div class="input-container ic1">
            <input type="text" id="email" class = "input" placeholder=" " name ="email"  required>
            <div class="cut cut-short"></div>
            <label for="email" class="placeholder">Email</label>
          </div>

          <div class="email error"></div>

          <div class="input-container ic1">
            <input type="text"  id="password" class="input"  placeholder=" " name ="password"  required />
            <div class="cut cut-short"></div>
            <label for="password" class="placeholder">Password</label>
          </div>

          <div class="password error"></div>
       
          <button type="text" class="submit">Submit</button>
        
          
      </form>
     
    </div>

   
       

    <script>
      function onSignIn(googleUser) {
        var id_token = googleUser.getAuthResponse().id_token;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/login");
        xhr.setRequestHeader(
          "Content-Type",
          "application/json"
        );
          xhr.onload = function () {
          console.log("Signed in as: " + xhr.responseText);
          if(xhr.responseText == 'success')
          {
            signOut();
            location.assign('/dashboard');
            //res.set({'Cache-Control': 'no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0'});
          }
          

        };
        xhr.send(JSON.stringify({token: id_token}));
        
      }
    </script>

    <script>
      function signOut() {

        var auth2 = gapi.auth2.getAuthInstance();
        //console.log(auth2);
        auth2.signOut().then(function () {
       //   localStorage.removeItem('token');
          console.log("User signed out.");
       
        });

      }
      const form = document.querySelector('form');
    const emailError = document.querySelector('.email.error');  
    const passwordError = document.querySelector('.password.error');  
    //get the values
    form.addEventListener('submit',async (e)=>{
       
        
    e.preventDefault();

    //Reset errors
    emailError.textContent = '';
    passwordError.textContent = '';

    const email =  form.email.value;
    const password = form.password.value;

    console.log(email,password);

    try{
    const res = await fetch('/login2',{

        method : 'POST',
        body : JSON.stringify({email,password}), // Eqvivalaent to {email : email , password : password}
        headers:{'Content-type' : 'application/json'}
    });

    const data = await res.json();
    console.log('Data : ' ,data);

    if(data.errors)
    {
        emailError.textContent = data.errors.email;
        passwordError.textContent = data.errors.password;
    }

    if(data.user){
        console.log('Data : ',data.user);
        location.assign('/dashboard');
    }

    }
    catch(err){
    console.log(err);
    }

    
    });
    
     

    </script>
    <%- include('./partials/foot.ejs') %>
  </body>
</html>
